// src/components/admin/AdminUserTable.tsx
import React, { useState } from "react";
import {
  Box,
  Typography,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Avatar,
  Chip,
  Collapse,
  IconButton
} from "@mui/material";
import KeyboardArrowDownIcon from "@mui/icons-material/KeyboardArrowDown";
import KeyboardArrowUpIcon from "@mui/icons-material/KeyboardArrowUp";

// Helper function
function alpha(color: string, opacity: number) {
  return color + Math.round(opacity * 255).toString(16).padStart(2, '0');
}

export type UserData = {
  id: string;
  email?: string;
  displayName?: string;
  role?: string;
  photoURL?: string;
  lastOnline?: any; 
  [key: string]: any;
};

type AdminUserTableProps = {
  usersList: UserData[];
  isDark: boolean;
  incidents: any[]; // üîπ ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
};

// üîπ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
const checkIsOnline = (lastOnline: any) => {
  if (!lastOnline) return false;
  const time = lastOnline.toDate ? lastOnline.toDate().getTime() : new Date(lastOnline).getTime();
  return (Date.now() - time) < (5 * 60 * 1000); // ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ
};

// ==========================================
// üîπ Component ‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö (Collapse) ‡πÑ‡∏î‡πâ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô
// ==========================================
function Row({ user, isDark, userIncidents }: { user: UserData; isDark: boolean; userIncidents: any[] }) {
  const [open, setOpen] = useState(false); // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î
  const isOnline = checkIsOnline(user.lastOnline);

  return (
    <React.Fragment>
      <TableRow 
        onClick={() => setOpen(!open)} // üîπ 1. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß
        sx={{ 
          "& > *": { borderBottom: "unset" }, 
          bgcolor: open ? (isDark ? alpha("#38bdf8", 0.05) : alpha("#1976d2", 0.05)) : "transparent", 
          transition: "0.2s",
          cursor: "pointer", // üîπ 2. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ô‡∏¥‡πâ‡∏ß‡∏ä‡∏µ‡πâ (‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏î‡πÑ‡∏î‡πâ)
          "&:hover": { bgcolor: isDark ? alpha("#fff", 0.05) : alpha("#000", 0.02) } // üîπ 3. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏≠‡∏ô‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ
        }}
      >
        
        {/* ‡∏ä‡πà‡∏≠‡∏á: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Ç‡∏¢‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å) */}
        <TableCell sx={{ p: { xs: 1, sm: 2 } }}>
          <Box sx={{ display: "flex", alignItems: "center", gap: 1.5 }}>
            <Avatar src={user.photoURL} sx={{ width: { xs: 32, sm: 40 }, height: { xs: 32, sm: 40 }, bgcolor: isDark ? "#334155" : "#e2e8f0", color: isDark ? "#fff" : "#475569" }}>
              {user.displayName ? user.displayName.charAt(0).toUpperCase() : "?"}
            </Avatar>
            <Box>
              <Typography fontWeight="bold" sx={{ color: isDark ? "#fff" : "text.primary", fontSize: { xs: "0.85rem", sm: "1rem" } }}>
                {user.displayName || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠"}
              </Typography>
              {/* ‡πÇ‡∏ä‡∏ß‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÜ */}
              <Typography variant="caption" sx={{ color: isDark ? "#94a3b8" : "text.secondary", display: { sm: "none" } }}>
                ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏: {userIncidents.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
              </Typography>
            </Box>
          </Box>
        </TableCell>

        {/* ‡∏ä‡πà‡∏≠‡∏á: ‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ã‡πà‡∏≠‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) */}
        <TableCell sx={{ color: isDark ? "#cbd5e1" : "text.secondary", display: { xs: "none", sm: "table-cell" } }}>
          {user.email}
          <Typography variant="caption" display="block" color={isDark ? "#94a3b8" : "text.secondary"}>
            ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏: {userIncidents.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          </Typography>
        </TableCell>

        {/* ‡∏ä‡πà‡∏≠‡∏á: ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó */}
        <TableCell sx={{ p: { xs: 1, sm: 2 } }}>
          <Chip 
            label={user.role === "admin" ? "‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•" : "‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å"} 
            size="small"
            sx={{ 
              bgcolor: user.role === "admin" ? alpha("#a855f7", 0.15) : alpha("#3b82f6", 0.15),
              color: user.role === "admin" ? "#a855f7" : "#3b82f6",
              fontWeight: "bold",
              fontSize: { xs: "0.7rem", sm: "0.8125rem" } 
            }} 
          />
        </TableCell>

        {/* ‡∏ä‡πà‡∏≠‡∏á: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */}
        <TableCell align="center" sx={{ p: { xs: 1, sm: 2 } }}>
          <Chip 
            label={isOnline ? "Online" : "Offline"} 
            size="small"
            sx={{ 
              bgcolor: isOnline ? alpha("#10b981", 0.15) : alpha("#64748b", 0.15),
              color: isOnline ? "#10b981" : (isDark ? "#94a3b8" : "#64748b"),
              fontWeight: "bold",
              border: isOnline ? "1px solid #10b981" : "none",
              fontSize: { xs: "0.7rem", sm: "0.8125rem" } 
            }} 
          />
        </TableCell>

        {/* üîπ ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î */}
        <TableCell align="right" sx={{ p: { xs: 1, sm: 2 }, width: 40 }}>
          <IconButton size="small" sx={{ color: isDark ? "#94a3b8" : "inherit" }}>
            {open ? <KeyboardArrowUpIcon color="primary" /> : <KeyboardArrowDownIcon />}
          </IconButton>
        </TableCell>

      </TableRow>

      {/* ========================================== */}
      {/* üîπ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà (‡∏à‡∏∞‡∏Ç‡∏¢‡∏≤‡∏¢‡∏•‡∏á‡∏°‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î) */}
      {/* ========================================== */}
      <TableRow>
        <TableCell style={{ paddingBottom: 0, paddingTop: 0 }} colSpan={5}>
          <Collapse in={open} timeout="auto" unmountOnExit>
            <Box sx={{ margin: 2, bgcolor: isDark ? "rgba(0,0,0,0.15)" : "#f8fafc", p: { xs: 1.5, sm: 2.5 }, borderRadius: 3, border: isDark ? "1px solid #334155" : "1px solid #e2e8f0" }}>
              <Typography variant="subtitle2" sx={{ color: isDark ? "#38bdf8" : "primary.main", fontWeight: "bold", mb: 1.5 }}>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á {user.displayName || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ"}
              </Typography>
              
              {userIncidents.length > 0 ? (
                <Box sx={{ display: "flex", flexDirection: "column", gap: 1 }}>
                  {userIncidents.map((inc, i) => (
                    <Box key={inc.id} sx={{ p: 1.5, bgcolor: isDark ? "#1e293b" : "#fff", borderRadius: 2, border: isDark ? "1px solid #334155" : "1px solid #e2e8f0" }}>
                      <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", gap: 1 }}>
                        <Typography variant="body2" fontWeight="bold" sx={{ color: isDark ? "#fff" : "text.primary" }}>
                          {i+1}. {inc.type} 
                        </Typography>
                        <Chip 
                          label={inc.status} 
                          size="small" 
                          sx={{ height: 20, fontSize: "0.7rem", fontWeight: "bold", bgcolor: inc.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ? alpha("#10b981", 0.15) : alpha("#f59e0b", 0.15), color: inc.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ? "#10b981" : "#f59e0b" }} 
                        />
                      </Box>
                      <Typography variant="caption" sx={{ color: isDark ? "#94a3b8" : "text.secondary", display: "block", mt: 0.5 }}>
                        üìç <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> {inc.location}
                      </Typography>
                      <Typography variant="caption" sx={{ color: isDark ? "#64748b" : "text.secondary", display: "block" }}>
                        üìÖ <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> {inc.createdAt ? new Date(inc.createdAt.toDate()).toLocaleString("th-TH") : "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤"}
                      </Typography>
                    </Box>
                  ))}
                </Box>
              ) : (
                <Typography variant="body2" sx={{ color: isDark ? "#94a3b8" : "text.secondary", fontStyle: "italic", textAlign: "center", py: 2 }}>
                  ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏
                </Typography>
              )}
            </Box>
          </Collapse>
        </TableCell>
      </TableRow>
    </React.Fragment>
  );
}

// ==========================================
// üîπ Component ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
// ==========================================
export default function AdminUserTable({ usersList, isDark, incidents }: AdminUserTableProps) {
  return (
    <TableContainer component={Paper} sx={{ borderRadius: 4, bgcolor: isDark ? "#1e293b" : "#fff", border: isDark ? "1px solid #334155" : "none", boxShadow: isDark ? "none" : "0 4px 12px rgba(0,0,0,0.05)", animation: "fadeIn 0.5s ease" }}>
      <Table sx={{ width: "100%" }}>
        <TableHead sx={{ bgcolor: isDark ? "#0f172a" : "#f1f5f9" }}>
          <TableRow>
            <TableCell sx={{ color: isDark ? "#94a3b8" : "text.secondary", fontWeight: "bold" }}>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</TableCell>
            <TableCell sx={{ color: isDark ? "#94a3b8" : "text.secondary", fontWeight: "bold", display: { xs: "none", sm: "table-cell" } }}>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</TableCell>
            <TableCell sx={{ color: isDark ? "#94a3b8" : "text.secondary", fontWeight: "bold" }}>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</TableCell>
            <TableCell align="center" sx={{ color: isDark ? "#94a3b8" : "text.secondary", fontWeight: "bold" }}>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</TableCell>
            <TableCell /> {/* üîπ ‡∏¢‡πâ‡∏≤‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î */}
          </TableRow>
        </TableHead>
        <TableBody>
          {usersList.length > 0 ? (
            usersList.map((user) => {
              // üîπ ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ (id) ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
              const userIncidents = incidents.filter(inc => inc.userId === user.id);
              
              return (
                <Row key={user.id} user={user} isDark={isDark} userIncidents={userIncidents} />
              );
            })
          ) : (
            <TableRow>
              <TableCell colSpan={5} align="center" sx={{ py: 4, color: isDark ? "#94a3b8" : "text.secondary" }}>
                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
              </TableCell>
            </TableRow>
          )}
        </TableBody>
      </Table>
    </TableContainer>
  );
}